name: Download Comet Latest (Win64)

on:
  schedule:
    - cron: '0 0 * * *'        # ogni giorno a mezzanotte UTC
  workflow_dispatch:            # avvio manuale da Actions

jobs:
  download:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false   # usiamo il PAT, non il token di default[web:49]

      - name: Download Comet Windows 64-bit
        run: |
          mkdir -p releases
          curl -L --fail --insecure -H "User-Agent: Mozilla/5.0" \
            -o releases/comet-installer-win_x64.exe \
            "https://www.perplexity.ai/rest/browser/download?platform=win_x64&channel=stable"[web:1]

      - name: Commit e Push con PAT
        env:
          PAT: ${{ secrets.PAT }}   # Personal Access Token creato nei secrets, con scope repo[web:48]
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add releases/
          git commit -m "Update Comet Win64: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" || echo "No changes"

          git remote set-url origin https://x-access-token:${PAT}@github.com/mich-de/comet.git
          git push origin main
