name: Download Comet Latest (Win64)

on:
  schedule:
    - cron: '0 0 * * *'        # Every day at midnight UTC
  workflow_dispatch:           # Allows manual trigger

permissions:
  contents: write              # REQUIRED: Allows creating releases and deleting tags

jobs:
  download:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0       # Fetch all history for tag operations

      - name: Download Comet Windows 64-bit
        run: |
          mkdir -p releases
          # Uses -L to follow redirects and --fail to stop on error
          curl -L --fail --insecure -H "User-Agent: Mozilla/5.0" \
            -o releases/comet-installer-win_x64.exe \
            "https://www.perplexity.ai/rest/browser/download?platform=win_x64&channel=stable"

      - name: Create/Update GitHub Release (comet-win64-latest)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: comet-win64-latest
          name: Comet Win64 Latest
          draft: false
          prerelease: false
          files: releases/comet-installer-win_x64.exe
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete all other releases and tags
        env:
          # Use GITHUB_TOKEN for both auth methods
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          set -e

          # Configure git for tag deletion
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          echo "Cleaning up old releases..."

          # Get ID of the release we just created/updated
          LATEST_ID=$(gh api \
            repos/$OWNER/$REPO/releases/tags/comet-win64-latest \
            --jq '.id')

          echo "Current Keep-Alive Release ID: $LATEST_ID"

          # List all releases
          ALL_IDS=$(gh api repos/$OWNER/$REPO/releases --paginate --jq '.[].id')

          for ID in $ALL_IDS; do
            if [ "$ID" != "$LATEST_ID" ] && [ -n "$ID" ]; then
              echo "Deleting old release ID=$ID"
              gh api \
                --method DELETE \
                repos/$OWNER/$REPO/releases/$ID || true
            fi
          done

          echo "Cleaning up old tags..."
          
          # Fetch all tags to ensure we see them
          git fetch --tags
          
          # List all tags
          TAGS=$(git tag -l)

          for TAG in $TAGS; do
            if [ "$TAG" != "comet-win64-latest" ]; then
              echo "Deleting tag $TAG"
              # Delete remote tag
              git push origin --delete "$TAG" || true
              # Delete local tag
              git tag -d "$TAG" || true
            fi
          done
