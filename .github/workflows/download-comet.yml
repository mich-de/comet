name: Download Comet Latest (Win64)

on:
  schedule:
    - cron: '0 0 * * *'        # Every day at midnight UTC
  workflow_dispatch:           # Allows manual trigger

permissions:
  contents: write              # REQUIRED: for committing Versions.MD and creating releases
  deployments: write           # REQUIRED: for cleaning up deployments

jobs:
  download:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download & Extract Version
        id: download
        run: |
          mkdir -p releases
          
          FINAL_URL=$(curl -Ls -o /dev/null -w %{url_effective} "https://www.perplexity.ai/rest/browser/download?platform=win_x64&channel=stable")
          echo "Detected Final URL: $FINAL_URL"
          
          VERSION=$(echo "$FINAL_URL" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' | head -n 1)
          if [ -z "$VERSION" ]; then
            VERSION="Unknown"
          fi
          echo "Detected Version: $VERSION"
          
          curl -L --fail --insecure -H "User-Agent: Mozilla/5.0" \
            -o releases/comet-installer-win_x64.exe \
            "https://www.perplexity.ai/rest/browser/download?platform=win_x64&channel=stable"
          
          FILE_SIZE=$(du -m releases/comet-installer-win_x64.exe | cut -f1)
          
          # Set the date HERE where shell is evaluated
          DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
          
          echo "FINAL_URL=$FINAL_URL" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "FILE_SIZE=${FILE_SIZE}MB" >> $GITHUB_ENV
          echo "BUILD_DATE=$DATE" >> $GITHUB_ENV

      - name: Create/Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: comet-win64-latest
          name: "Comet Win64 â€” v${{ env.VERSION }}"
          body: |
            ## ðŸš€ Comet Browser v${{ env.VERSION }}
            
            | Info | Value |
            |------|-------|
            | **Version** | `${{ env.VERSION }}` |
            | **Size** | ${{ env.FILE_SIZE }} |
            | **Platform** | Windows x64 |
            | **Updated** | ${{ env.BUILD_DATE }} |
            
            _Mirrored automatically from Perplexity's official servers._
          draft: false
          prerelease: false
          files: releases/comet-installer-win_x64.exe
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Update VERSIONS.md
        run: |
          DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          FILE="VERSIONS.md"
          HEADER="| Date | Version | Size | Source URL |"
          SEPARATOR="|------|---------|------|------------|"
          
          # ALWAYS ensure header exists
          if [ ! -f "$FILE" ] || ! grep -q "^| Date" "$FILE"; then
            echo "$HEADER" > "$FILE"
            echo "$SEPARATOR" >> "$FILE"
          fi
          
          # Clean the source URL (strip query params)
          CLEAN_URL=$(echo "$FINAL_URL" | cut -d'?' -f1)
          
          # Prepend new entry after header
          NEW_LINE="| $DATE | **$VERSION** | $FILE_SIZE | $CLEAN_URL |"
          
          head -n 2 "$FILE" > temp_versions.md
          echo "$NEW_LINE" >> temp_versions.md
          tail -n +3 "$FILE" >> temp_versions.md
          mv temp_versions.md "$FILE"
          
          echo "=== Updated VERSIONS.md ==="
          cat "$FILE"

      - name: Commit VERSIONS.md
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          git add VERSIONS.md
          if git diff --staged --quiet; then
            echo "No changes to VERSIONS.md"
          else
            git commit -m "ðŸ“¦ Comet $VERSION"
            git pull --rebase origin main
            git push
          fi


      - name: Create/Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: comet-win64-latest
          name: "Comet Win64 â€” v${{ env.VERSION }}"
          body: |
            ## ðŸš€ Comet Browser v${{ env.VERSION }}
            
            | Info | Value |
            |------|-------|
            | **Version** | `${{ env.VERSION }}` |
            | **Size** | ${{ env.FILE_SIZE }} |
            | **Platform** | Windows x64 |
            | **Updated** | ${{ env.DATE }} |
            
            _Mirrored automatically from Perplexity's official servers._
          draft: false
          prerelease: false
          files: releases/comet-installer-win_x64.exe
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DATE: $(date -u +"%Y-%m-%d")

      - name: Cleanup Old Releases/Tags
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          set -e
          echo "Starting cleanup..."

          LATEST_ID=$(gh api repos/$OWNER/$REPO/releases/tags/comet-win64-latest --jq '.id')
          ALL_IDS=$(gh api repos/$OWNER/$REPO/releases --paginate --jq '.[].id')

          for ID in $ALL_IDS; do
            if [ "$ID" != "$LATEST_ID" ] && [ -n "$ID" ]; then
              echo "Deleting obsolete release ID=$ID"
              gh api --method DELETE repos/$OWNER/$REPO/releases/$ID || true
            fi
          done

          git fetch --tags
          TAGS=$(git tag -l)
          for TAG in $TAGS; do
            if [ "$TAG" != "comet-win64-latest" ]; then
              echo "Deleting obsolete tag $TAG"
              git push origin --delete "$TAG" || true
              git tag -d "$TAG" || true
            fi
          done

      - name: Cleanup Deployments
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -e
          echo "Fetching list of deployments..."
          
          IDS=$(gh api "repos/$REPO/deployments?per_page=100" --paginate --jq '.[].id')
          
          if [ -z "$IDS" ]; then
            echo "No deployments found."
            exit 0
          fi
          
          for ID in $IDS; do
            echo "Deleting deployment $ID..."
            gh api --method DELETE "repos/$REPO/deployments/$ID" || true
          done
          
          echo "Cleanup complete!"
