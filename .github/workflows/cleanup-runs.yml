name: Cleanup Workflow Runs

on:
  schedule:
    - cron: '30 0 * * *'       # Runs daily at 00:30 UTC
  workflow_dispatch:           # Manual trigger

permissions:
  actions: write               # REQUIRED: to delete workflow runs

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Cleanup all workflow runs (keep latest success per workflow)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -e
          echo "๐งน Cleaning up ALL workflow runs across ALL actions..."
          echo ""

          # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          # PART 1: Active workflows (existing .yml files)
          # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          echo "๐ PART 1: Active Workflows"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

          WORKFLOW_IDS=$(gh api "repos/$REPO/actions/workflows" --paginate --jq '.workflows[].id')

          for WF_ID in $WORKFLOW_IDS; do
            WF_NAME=$(gh api "repos/$REPO/actions/workflows/$WF_ID" --jq '.name')
            echo ""
            echo "โธ $WF_NAME (ID: $WF_ID)"

            RUNS_JSON=$(gh api "repos/$REPO/actions/workflows/$WF_ID/runs?per_page=100" --paginate \
              --jq '.workflow_runs | sort_by(.created_at) | reverse | .[] | "\(.id)|\(.conclusion)|\(.status)"')

            KEPT_ONE=false

            while IFS= read -r LINE; do
              [ -z "$LINE" ] && continue
              RUN_ID=$(echo "$LINE" | cut -d'|' -f1)
              CONCLUSION=$(echo "$LINE" | cut -d'|' -f2)
              STATUS=$(echo "$LINE" | cut -d'|' -f3)

              # Skip if still running
              if [ "$STATUS" = "in_progress" ] || [ "$STATUS" = "queued" ]; then
                echo "    โณ $RUN_ID โ still running, skip"
                continue
              fi

              # Keep latest successful
              if [ "$KEPT_ONE" = false ] && [ "$CONCLUSION" = "success" ]; then
                echo "    โ $RUN_ID โ KEEP (latest success)"
                KEPT_ONE=true
                continue
              fi

              # Delete the rest
              echo "    ๐๏ธ  $RUN_ID โ DELETE ($CONCLUSION)"
              gh api --method DELETE "repos/$REPO/actions/runs/$RUN_ID" || true
            done <<< "$RUNS_JSON"

            if [ "$KEPT_ONE" = false ]; then
              echo "    โ๏ธ  No successful runs found"
            fi
          done

          # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          # PART 2: Orphaned runs (from deleted workflows)
          # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          echo ""
          echo "๐ PART 2: Orphaned Runs (deleted workflows)"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

          # Collect all active workflow IDs into a set
          ACTIVE_WF_IDS=$(gh api "repos/$REPO/actions/workflows" --paginate --jq '.workflows[].id')

          # Get ALL runs in the repo
          ALL_RUNS=$(gh api "repos/$REPO/actions/runs?per_page=100" --paginate \
            --jq '.workflow_runs[] | "\(.id)|\(.workflow_id)|\(.name)"')

          ORPHAN_COUNT=0

          while IFS= read -r LINE; do
            [ -z "$LINE" ] && continue
            RUN_ID=$(echo "$LINE" | cut -d'|' -f1)
            RUN_WF_ID=$(echo "$LINE" | cut -d'|' -f2)
            RUN_NAME=$(echo "$LINE" | cut -d'|' -f3)

            # Check if this run's workflow still exists
            IS_ACTIVE=false
            for AID in $ACTIVE_WF_IDS; do
              if [ "$AID" = "$RUN_WF_ID" ]; then
                IS_ACTIVE=true
                break
              fi
            done

            if [ "$IS_ACTIVE" = false ]; then
              echo "  ๐๏ธ  Orphan: $RUN_NAME (run $RUN_ID, old workflow $RUN_WF_ID)"
              gh api --method DELETE "repos/$REPO/actions/runs/$RUN_ID" || true
              ORPHAN_COUNT=$((ORPHAN_COUNT + 1))
            fi
          done <<< "$ALL_RUNS"

          if [ "$ORPHAN_COUNT" -eq 0 ]; then
            echo "  โ No orphaned runs found"
          else
            echo "  ๐๏ธ  Deleted $ORPHAN_COUNT orphaned runs"
          fi

          echo ""
          echo "โ Full cleanup complete!"
