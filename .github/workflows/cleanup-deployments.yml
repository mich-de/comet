name: Cleanup Deployments

on:
  workflow_dispatch:

jobs:
  cleanup-deployments:
    runs-on: ubuntu-latest
    permissions:
      contents: read    # per usare il repo; i permessi reali arrivano dal PAT

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        uses: cli/cli-action@v2

      - name: Delete all deployments (all environments)
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}   # il tuo PAT, NON GITHUB_TOKEN
          REPO: mich-de/comet
        run: |
          set -e

          echo "Recupero lista deployments..."
          IDS=$(gh api --method GET "repos/$REPO/deployments?per_page=100" -q '.[].id')

          if [ -z "$IDS" ]; then
            echo "Nessun deployment trovato."
            exit 0
          fi

          for ID in $IDS; do
            echo "Elimino deployment $ID"
            gh api \
              --method DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "repos/$REPO/deployments/$ID" || true
          done
